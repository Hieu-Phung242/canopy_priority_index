library(sf)
library(dplyr)
library(leaflet)
library(DT)
library(sf)
library(dplyr)
library(leaflet)
library(DT)
nbhd <- st_read("neighborhood_master.geojson")
nbhd <- st_read("neighborhood_master.geojson", quiet = TRUE) %>%
st_transform(4326)
library(sf)
library(dplyr)
library(leaflet)
library(DT)
library(sf)
library(dplyr)
library(leaflet)
library(DT)
# Canopy Priority Index (CPI) Map
# Color palette for CPI classes
pal_cpi <- colorFactor(
palette = c(
"High" = "#d73027",
"Medium" = "#fee08b",
"Low" = "#1a9850"
),
domain = nbhd$CPI_class
)
# Leaflet map
leaflet(nbhd) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
addPolygons(
fillColor = ~pal_cpi(CPI_class),
fillOpacity = 0.75,
color = "black",
weight = 0.4,
label = ~paste0(
"<b>", Name, "</b><br>",
"CPI: ", round(CPI, 3), "<br>",
"Priority: ", CPI_class
),
highlightOptions = highlightOptions(
weight = 2,
color = "white",
bringToFront = TRUE
)
) %>%
addLegend(
pal = pal_cpi,
values = ~CPI_class,
title = "CPI Priority"
)
library(sf)
library(dplyr)
library(leaflet)
library(DT)
nbhd <- st_read("neighborhood_master.geojson", quiet = TRUE) %>%
st_transform(4326)
library(htmltools)
library(htmlwidgets)
library(jsonlite)
# ---- palettes ----
nbhd$CPI_class <- factor(
nbhd$CPI_class,
levels = c("High", "Medium", "Low")
)
pal_cpi  <- colorFactor(c("High"="#d73027","Medium"="#fee08b","Low"="#1a9850"), domain = nbhd$CPI_class)
pal_ndvi <- colorNumeric("YlGn",    domain = nbhd$NDVI_mean, na.color = "transparent")
pal_ndbi <- colorNumeric("YlOrBr",  domain = nbhd$NDBI_mean, na.color = "transparent")
pal_lst  <- colorNumeric("inferno", domain = nbhd$LST_mean,  na.color = "transparent")
# ---- hover label (tooltip) ----
label_html <- sprintf(
"<b>%s</b><br>
CPI: %s<br>
Priority: %s<br>
NDVI (mean): %s<br>
NDBI (mean): %s<br>
LST (mean): %s",
nbhd$Name,
round(nbhd$CPI, 3),
nbhd$CPI_class,
round(nbhd$NDVI_mean, 3),
round(nbhd$NDBI_mean, 3),
round(nbhd$LST_mean, 2)
) %>% lapply(HTML)
# ---- styling shared by all layers ----
hl <- highlightOptions(weight = 2, color = "white", bringToFront = TRUE)
# ---- numeric legend builder ----
make_numeric_legend <- function(title, pal, x, n = 6, digits = 2) {
brks <- pretty(x, n = n)
brks <- brks[is.finite(brks)]
cols <- pal(brks)
rows <- paste0(
"<div style='display:flex;align-items:center;gap:8px;margin:4px 0;'>",
"<span style='width:14px;height:14px;border:1px solid #999;border-radius:3px;background:", cols, ";'></span>",
formatC(brks, digits = digits, format = "f"),
"</div>",
collapse = ""
)
paste0(
"<div style='padding:10px 12px;background:white;border:1px solid #ddd;border-radius:10px;box-shadow:0 1px 8px rgba(0,0,0,0.12);'>",
"<div style='font-weight:700;margin-bottom:6px;'>", title, "</div>",
rows,
"</div>"
)
}
legend_cpi <- paste0(
"<div style='padding:10px 12px;background:white;border:1px solid #ddd;border-radius:10px;box-shadow:0 1px 8px rgba(0,0,0,0.12);'>",
"<div style='font-weight:700;margin-bottom:6px;'>CPI Priority</div>",
"<div style='display:flex;align-items:center;gap:8px;margin:4px 0;'><span style='width:14px;height:14px;border:1px solid #999;border-radius:3px;background:#d73027;'></span>High</div>",
"<div style='display:flex;align-items:center;gap:8px;margin:4px 0;'><span style='width:14px;height:14px;border:1px solid #999;border-radius:3px;background:#fee08b;'></span>Medium</div>",
"<div style='display:flex;align-items:center;gap:8px;margin:4px 0;'><span style='width:14px;height:14px;border:1px solid #999;border-radius:3px;background:#1a9850;'></span>Low</div>",
"</div>"
)
legends <- list(
"CPI (Priority)" = legend_cpi,
"NDVI (Mean)"    = make_numeric_legend("NDVI (Mean)", pal_ndvi, nbhd$NDVI_mean, digits = 3),
"NDBI (Mean)"    = make_numeric_legend("NDBI (Mean)", pal_ndbi, nbhd$NDBI_mean, digits = 3),
"LST (Mean)"     = make_numeric_legend("LST (Mean)",  pal_lst,  nbhd$LST_mean,  digits = 2)
)
# ---- build map (with tooltips + highlight) ----
m <- leaflet(nbhd) %>%
addProviderTiles(providers$CartoDB.Positron, group = "Base") %>%
addPolygons(
group="CPI (Priority)",
fillColor = ~pal_cpi(CPI_class),
fillOpacity = 0.75,
color="black", weight=0.4,
label = label_html,
highlightOptions = hl
) %>%
addPolygons(
group="NDVI (Mean)",
fillColor = ~pal_ndvi(NDVI_mean),
fillOpacity = 0.75,
color="black", weight=0.4,
label = label_html,
highlightOptions = hl
) %>%
addPolygons(
group="NDBI (Mean)",
fillColor = ~pal_ndbi(NDBI_mean),
fillOpacity = 0.75,
color="black", weight=0.4,
label = label_html,
highlightOptions = hl
) %>%
addPolygons(
group="LST (Mean)",
fillColor = ~pal_lst(LST_mean),
fillOpacity = 0.75,
color="black", weight=0.4,
label = label_html,
highlightOptions = hl
) %>%
addLayersControl(
baseGroups = c("Base"),
overlayGroups = c("CPI (Priority)", "NDVI (Mean)", "NDBI (Mean)", "LST (Mean)"),
options = layersControlOptions(collapsed = FALSE)
) %>%
hideGroup(c("NDVI (Mean)", "NDBI (Mean)", "LST (Mean)")) %>%
# one single legend container
addControl(html = HTML(legends[["CPI (Priority)"]]),
position = "topright",
layerId = "legend_box")
# ---- JS: swap legend content ----
onRender(
m,
sprintf(
"
function(el, x) {
var map = this;
var box = document.getElementById('legend_box');
var legends = %s;
function setLegend(name) {
if (!box) return;
if (legends[name]) box.innerHTML = legends[name];
}
setLegend('CPI (Priority)');
map.on('overlayadd', function(e){
setLegend(e.name);
});
map.on('overlayremove', function(e){
// if user turns off the currently displayed legend, show a neutral message
if (box && box.innerHTML === legends[e.name]) {
box.innerHTML = \"<div style='padding:10px 12px;background:white;border:1px solid #ddd;border-radius:10px;'>Turn on a layer to see its legend.</div>\";
}
});
}
",
toJSON(legends, auto_unbox = TRUE)
)
)
